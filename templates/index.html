<!DOCTYPE html>
<html lang="en">
{% macro position_select(name, id, selected_val, title="Select Position", classes="form-select") %}
    <select name="{{ name }}" id="{{ id }}" class="{{ classes }}" title="{{ title }}">
        <option value="" {% if not selected_val %}selected{% endif %}>{{ title }}</option>
        {% set positions = ['P', 'C', '1B', '2B', '3B', 'SS', 'LF', 'CF', 'RF', 'DH', 'EH'] %}
        {% for pos in positions %}
            <option value="{{ pos }}" {% if selected_val == pos %}selected{% endif %}>{{ pos }}</option>
        {% endfor %}
    </select>
{% endmacro %}
<head>
  <meta charset="UTF-8">
  {# MODIFIED: Title is now dynamic #}
  <title>{% if current_team %}{{ current_team.team_name }} - Coach Planner{% else %}Coach Planner{% endif %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="manifest" href="/static/manifest.json">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  <style>
    body {
        padding-bottom: 120px;
    }
    .navbar-brand .brand-text { font-size: 1.25rem; white-space: nowrap; }
    @media (max-width: 768px) {
        .navbar-brand .brand-text { font-size: 1rem; white-space: normal; line-height: 1.2; }
        .navbar-brand { padding-right: 0; }
    }
    @media (max-width: 480px) { .navbar-brand .brand-text { font-size: 0.9rem; } }
    .practice-plan { border-left: 3px solid #c8102e; }
    .task-item.complete { text-decoration: line-through; opacity: 0.6; }

    
    /* --- MODIFIED: Adjusted padding for bottom nav --- */
    .bottom-nav {
        /* The height is now determined by the content and padding below */
        padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
        box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
    }
    .bottom-nav .nav-link {
        font-size: 0.75rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 0.5rem 0;
        border-top: 3px solid transparent;
        flex: 1; 
    }
    .bottom-nav .nav-link i { font-size: 1.7rem; margin-bottom: 2px; }
    .bottom-nav .nav-link.active { 
        color: #c8102e; 
        border-top: 3px solid #c8102e;
    }

    
    .more-menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(248, 249, 250, 0.98); 
        z-index: 1040; 
        padding: 20px;
        overflow-y: auto;
        transition: opacity 0.3s ease-in-out;
    }
    .more-menu-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }
    .more-menu-close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 2rem;
        color: #6c757d;
        cursor: pointer;
        line-height: 1;
    }


    /* Desktop Nav Bar */
    .navbar-nav .nav-link.active {
      background-color: #c8102e;
      color: white;
      border-radius: 0.25rem;
    }
    .navbar-nav .nav-link { color: #212529; font-weight: 500; }
    .navbar-nav .nav-link:hover { color: #c8102e; }
    .navbar-nav .nav-link.active:hover { color: white; }

    @media (min-width: 992px) {
        #navbarResponsive { display: flex; align-items: center; width: 100%; }
        .tab-content > .tab-pane { display: none; }
        .tab-content > .tab-pane.active { display: block; }
        body { padding-bottom: 0; } 
    }

    @media (max-width: 991.98px) {
        #mainTabsDesktop .drag-handle { display: none; }
        .tab-content > .tab-pane { display: none; }
        .tab-content > .tab-pane.active { display: block; }
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
  <div class="container-fluid">
    {# MODIFIED: Navbar brand is now fully dynamic #}
    <a class="navbar-brand d-flex align-items-center" href="{{ url_for('home') }}">
      {% if current_team and current_team.logo_path %}
          <img src="{{ url_for('static', filename='uploads/logos/' + current_team.logo_path) }}" alt="{{ current_team.team_name }} Logo" style="height: 40px; margin-right: 10px;">
      {% endif %}
      <span class="fw-bold brand-text">
        {% if current_team %}
            {{ current_team.team_name }} - Coach Planner
        {% else %}
            Coach Planner
        {% endif %}
      </span>
    </a>
    <div class="collapse navbar-collapse d-none d-lg-flex" id="navbarResponsive">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0 desktop-nav" id="mainTabsDesktop" role="tablist">
            {% for tab_key in tab_order %}
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#{{ tab_key }}" role="tab">
                    <i class="bi bi-grip-vertical me-1 drag-handle" title="Drag to reorder"></i>
                    {{ all_tabs[tab_key] }}
                </a>
            </li>
            {% endfor %}
        </ul>
        <ul class="navbar-nav desktop-nav">
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="userMenuDesktop" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    Welcome, {{ session.username }}!
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuDesktop">
                    {% if session.role in ['Head Coach', 'Super Admin'] %}
                    <li><a class="dropdown-item" href="{{ url_for('user_management') }}">User Management</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('admin_settings') }}">Admin Settings</a></li>
                    <li><hr class="dropdown-divider"></li>
                    {% endif %}
                    <li><a class="dropdown-item" href="{{ url_for('change_password') }}">Change Password</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('logout') }}">Logout</a></li>
                </ul>
            </li>
        </ul>
    </div>
  </div>
</nav>

<div class="container-fluid">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="tab-content">
    <div class="tab-pane fade" id="roster">
        <h4 class="mb-3">Current Roster</h4>
        <div class="mb-3">
          <input type="search" id="rosterSearch" class="form-control" placeholder="Search for a player...">
        </div>
        <div class="accordion" id="rosterAccordion"></div>
    </div>

    <div class="tab-pane fade" id="player_development">
        <h4>Player Development</h4>
        <p>Track development goals and view a complete activity log for each player. Drag players to reorder the list.</p>
        <div class="accordion" id="player-dev-accordion"></div>
    </div>

    <div class="tab-pane fade" id="lineups">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Unassigned Lineups</h4>
        <button class="btn btn-primary" id="createLineupBtn" data-bs-toggle="modal" data-bs-target="#lineupEditorModal">Create New Unassigned Lineup</button>
      </div>
      <div class="accordion" id="lineupsAccordion"></div>
    </div>

    <div class="tab-pane fade" id="pitching">
        <h4>Pitching Log & Count Tracker</h4>
        <div class="card mb-4">
          <div class="card-header"><strong>Pitch Count Summary</strong></div>
          <div class="card-body p-2"><div class="table-responsive" id="pitch-count-summary-container"></div></div>
        </div>
        <div class="row">
          <div class="col-lg-5 mb-4">
            <div class="card h-100">
              <div class="card-header"><strong>Add New Outing</strong></div>
              <div class="card-body">
                <form action="{{ url_for('add_pitching') }}" method="POST">
                  <div class="row g-3">
                    <div class="col-6"><label for="pitch_date" class="form-label">Date</label><input type="date" id="pitch_date" name="pitch_date" class="form-control" required></div>
                    <div class="col-6"><label for="pitching-log-pitcher-select" class="form-label">Pitcher</label><select name="pitcher" class="form-select" required id="pitching-log-pitcher-select"></select></div>
                    <div class="col-12"><label for="opponent" class="form-label">Opponent / Context</label><input type="text" id="opponent" name="opponent" class="form-control" placeholder="e.g., Scrimmage vs. Tigers"></div>
                    <div class="col-6"><label for="pitches" class="form-label">Pitch Count</label><input type="number" id="pitches" name="pitches" class="form-control" required></div>
                    <div class="col-6"><label for="innings" class="form-label">Innings Pitched</label><input type="text" id="innings" name="innings" class="form-control" placeholder="e.g., 2.1" required></div>
                    <div class="col-6"><label for="outing_type" class="form-label">Outing Type</label><select name="outing_type" id="outing_type" class="form-select"><option value="Game">Game</option><option value="External/Lesson">External/Lesson</option><option value="Practice">Practice</option></select></div>
                    <div class="col-6"><label for="pitcher_type" class="form-label">Pitcher Type</label><select name="pitcher_type" id="pitcher_type" class="form-select"><option value="Starter">Starter</option><option value="Reliever">Reliever</option></select></div>
                  </div>
                  <button type="submit" class="btn btn-primary w-100 mt-3">Log Outing</button>
                </form>
              </div>
            </div>
          </div>
          <div class="col-lg-7 mb-4">
             <div class="card h-100">
                <div class="card-header"><strong>Recent Outing History</strong></div>
                <div class="card-body p-0"><ul class="list-group list-group-flush" id="recorded-outings-list"></ul></div>
             </div>
          </div>
        </div>
      </div>

    <div class="tab-pane fade" id="scouting_list">
        <h4 class="mb-3">Scouting & Recruiting Lists</h4>
        <div class="row" id="scouting-list-container"><div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div></div>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Add New Scouted Player</h5>
                <form id="addScoutedPlayerForm" class="row g-3">
                    <div class="col-md-3"><input type="text" class="form-control" name="scouted_player_name" placeholder="Player Name" required></div>
                    <div class="col-md-2">{{ position_select('scouted_player_pos1', 'scouted_player_pos1', '', title='Pos 1') }}</div>
                    <div class="col-md-2">{{ position_select('scouted_player_pos2', 'scouted_player_pos2', '', title='Pos 2') }}</div>
                    <div class="col-md-2"><select name="scouted_player_throws" class="form-select"><option value="">Throws</option><option value="Right">Right</option><option value="Left">Left</option></select></div>
                    <div class="col-md-2"><select name="scouted_player_bats" class="form-select"><option value="">Bats</option><option value="Right">Right</option><option value="Left">Left</option></select></div>
                    <div class="col-md-4"><label class="form-label">Add to List:</label><select name="scouted_player_type" class="form-select"><option value="targets">Targets</option><option value="committed">Committed</option><option value="not_interested">Not Interested</option></select></div>
                    <div class="col-md-2 d-flex align-items-end"><button type="submit" class="btn btn-primary w-100">Add Player</button></div>
                </form>
                <div id="addScoutedPlayerFeedback" class="mt-2"></div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="rotations">
        <h4>Unassigned Rotations</h4>
        <p>Manage rotations that are not linked to a specific game. Game-specific rotations should be managed from the <a href="#games" data-bs-toggle="tab">Games</a> tab.</p>
        <div class="accordion" id="rotationsAccordion"></div>
    </div>

    <div class="tab-pane fade" id="games">
        <h4>Game Schedule & Management</h4>
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Add New Game</h5>
                <form action="{{ url_for('add_game') }}" method="POST" class="row g-3">
                    <div class="col-md-3"><input type="date" name="game_date" id="add_game_date" class="form-control" required></div>
                    <div class="col-md-3"><input type="text" name="game_opponent" class="form-control" placeholder="Opponent" required></div>
                    <div class="col-md-3"><input type="text" name="game_location" class="form-control" placeholder="Location"></div>
                    <div class="col-md-3"><button type="submit" class="btn btn-primary w-100">Add Game & Manage</button></div>
                    <div class="col-12"><textarea name="game_notes" class="form-control" rows="2" placeholder="Game Notes (e.g., arrival time, uniform)"></textarea></div>
                </form>
            </div>
        </div>
        <ul class="list-group" id="games-list-container"></ul>
    </div>

    <div class="tab-pane fade" id="collaboration">
        <h4>Coaches Log</h4>
        <div class="row">
            <div class="col-md-6">
                <h5>Team Notes</h5>
                <div class="card mb-3"><div class="card-body">
                    <form action="{{ url_for('add_note', note_type='team_notes') }}" method="POST">
                        <textarea name="note_text" class="form-control mb-2" rows="3" placeholder="Add a new note for the whole team..."></textarea>
                        <button type="submit" class="btn btn-primary btn-sm">Add Team Note</button>
                    </form>
                </div></div>
                <div id="team-notes-container"></div>
            </div>
            <div class="col-md-6">
                <h5>Player Notes</h5>
                <div class="card mb-3"><div class="card-body">
                    <form action="{{ url_for('add_note', note_type='player_notes') }}" method="POST">
                        <select name="player_name" class="form-select mb-2" required id="collab-player-select"></select>
                        <textarea name="note_text" class="form-control mb-2" rows="3" placeholder="Add a new note for the selected player..."></textarea>
                        <button type="submit" class="btn btn-primary btn-sm">Add Player Note</button>
                    </form>
                </div></div>
                <div id="player-notes-container"></div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="practice_plan">
        <h4>Practice Plans</h4>
        <div class="card mb-4"><div class="card-body">
            <h5 class="card-title">Create New Practice Plan</h5>
            <form action="{{ url_for('add_practice_plan') }}" method="POST">
                <div class="row">
                    <div class="col-md-3"><input type="date" name="plan_date" class="form-control" required></div>
                    <div class="col-md-7"><input type="text" name="general_notes" class="form-control" value="" placeholder="General theme or focus for the practice"></div>
                    <div class="col-md-2"><button type="submit" class="btn btn-primary w-100">Create Plan</button></div>
                </div>
            </form>
        </div></div>
        <div class="accordion" id="practicePlanAccordion"></div>
    </div>

    <div class="tab-pane fade" id="signs">
      <h4>Signs & Signals</h4>
        <div class="row">
            <div class="col-md-6"><div class="card"><div class="card-body">
                <h5 class="card-title">Add New Sign</h5>
                <form action="{{ url_for('add_sign') }}" method="POST">
                    <div class="mb-2"><input type="text" name="sign_name" class="form-control" placeholder="Sign Name (e.g., Steal, Bunt)" required></div>
                    <div class="mb-2"><input type="text" name="sign_indicator" class="form-control" placeholder="Indicator (e.g., Touch Belt)" required></div>
                    <button type="submit" class="btn btn-primary">Add Sign</button>
                </form>
            </div></div></div>
            <div class="col-md-6"><ul class="list-group" id="signs-list-container"></ul></div>
        </div>
    </div>
  </div>
</div>

<div class="more-menu-overlay hidden" id="more">
    <span class="more-menu-close-btn" id="more-menu-close-btn">&times;</span>
    <h4 class="mb-3">More Options</h4>
    <div class="list-group mb-4">
        <a class="list-group-item list-group-item-action" href="{{ url_for('pitching_rules') }}"><i class="bi bi-gavel me-2"></i>Pitching Rules</a>
        <a class="list-group-item list-group-item-action" data-bs-toggle="tab" href="#scouting_list" role="tab"><i class="bi bi-binoculars-fill me-2"></i>Scouting List</a>
        <a class="list-group-item list-group-item-action" data-bs-toggle="tab" href="#pitching" role="tab"><i class="bi bi-bullseye me-2"></i>Pitching Log</a>
        <a class="list-group-item list-group-item-action" data-bs-toggle="tab" href="#collaboration" role="tab"><i class="bi bi-people-fill me-2"></i>Coaches Log</a>
        <a class="list-group-item list-group-item-action" data-bs-toggle="tab" href="#signs" role="tab"><i class="bi bi-signpost-split-fill me-2"></i>Signs & Signals</a>
    </div>
    <div class="list-group">
        {% if session.role in ['Head Coach', 'Super Admin'] %}
        <a class="list-group-item list-group-item-action" href="{{ url_for('user_management') }}"><i class="bi bi-person-badge-fill me-2"></i>User Management</a>
        <a class="list-group-item list-group-item-action" href="{{ url_for('admin_settings') }}"><i class="bi bi-gear-fill me-2"></i>Team Settings</a>
        {% endif %}
        <a class="list-group-item list-group-item-action" href="{{ url_for('change_password') }}"><i class="bi bi-key-fill me-2"></i>Change Password</a>
        <a class="list-group-item list-group-item-action" href="{{ url_for('logout') }}"><i class="bi bi-box-arrow-right me-2"></i>Logout</a>
    </div>
</div>


<nav class="navbar fixed-bottom bg-light border-top d-lg-none bottom-nav">
  <div class="container-fluid d-flex justify-content-around nav nav-tabs" id="mobile-nav-tabs" role="tablist">
    <a class="nav-link text-center" data-bs-toggle="tab" href="#roster" role="tab"><i class="bi bi-people-fill"></i>Roster</a>
    <a class="nav-link text-center" data-bs-toggle="tab" href="#player_development" role="tab"><i class="bi bi-graph-up-arrow"></i>Development</a>
    <a class="nav-link text-center" data-bs-toggle="tab" href="#games" role="tab"><i class="bi bi-calendar-event"></i>Games</a>
    <a class="nav-link text-center" data-bs-toggle="tab" href="#practice_plan" role="tab"><i class="bi bi-clipboard-check"></i>Practice</a>
    <a class="nav-link text-center" id="mobile-more-button" href="#"><i class="bi bi-three-dots"></i>More</a>
  </div>
</nav>

<div class="modal fade" id="lineupEditorModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title" id="lineupEditorTitle">Unassigned Lineup Editor</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form id="lineupEditorForm" onsubmit="return false;">
                <input type="hidden" id="lineupId" name="lineup_id">
                <div class="row mb-3">
                    <div class="col-12"><label for="lineupTitle" class="form-label">Lineup Title</label><input type="text" class="form-control" id="lineupTitle" required></div>
                </div>
                <div class="row" id="lineup-editor-lists">
                    <div class="col-md-6"><h6>Available Players</h6><div id="lineup-bench" class="list-group border rounded p-2" style="min-height: 400px; max-height: 50vh; overflow-y: auto;"></div></div>
                    <div class="col-md-6"><h6>Batting Order</h6><div id="lineup-order" class="list-group border rounded p-2" style="min-height: 400px; max-height: 50vh; overflow-y: auto;"></div></div>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" id="saveLineupBtn" class="btn btn-primary">Save Lineup</button></div>
    </div></div>
</div>
<div class="modal fade" id="editNoteModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Edit Note</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <form id="editNoteForm" action="{{ url_for('edit_note') }}" method="POST">
      <div class="modal-body"><input type="hidden" id="editNoteId" name="note_id"><input type="hidden" id="editNoteType" name="note_type"><div class="mb-3"><label for="editNoteText" class="form-label">Note Text</label><textarea class="form-control" id="editNoteText" name="note_text" rows="5" required></textarea></div></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Save Changes</button></div>
    </form>
  </div></div>
</div>
<div class="modal fade" id="editFocusModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <form id="focusForm" method="POST">
      <div class="modal-header"><h5 class="modal-title" id="focusModalTitle">Development Focus</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <input type="hidden" id="focusId" name="focus_id">
        <div class="mb-3"><label for="focusSkill" class="form-label">Skill Area</label><select id="focusSkill" name="skill" class="form-select" required><option value="hitting">Hitting</option><option value="pitching">Pitching</option><option value="fielding">Fielding</option><option value="baserunning">Baserunning</option></select></div>
        <div class="mb-3"><label for="focusText" class="form-label">Focus / Goal</label><input type="text" class="form-control" id="focusText" name="focus_text" required></div>
        <div class="mb-3"><label for="focusNotes" class="form-label">Additional Notes</label><textarea class="form-control" id="focusNotes" name="notes" rows="3"></textarea></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Save Focus</button></div>
    </form>
  </div></div>
</div>
<div class="modal fade" id="editSignModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Edit Sign</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <form id="editSignForm" method="POST">
            <div class="modal-body">
                <input type="hidden" name="index" id="editSignIndex">
                <div class="mb-2"><label class="form-label">Sign Name</label><input type="text" id="editSignName" name="sign_name" class="form-control" required></div>
                <div class="mb-2"><label class="form-label">Indicator</label><input type="text" id="editSignIndicator" name="sign_indicator" class="form-control" required></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Save Changes</button></div>
        </form>
    </div></div>
</div>


<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/static/service-worker.js')
            .then(reg => console.log('Service worker registered.', reg))
            .catch(err => console.log('Service worker not registered.', err));
    }
</script>

<script>

document.addEventListener('DOMContentLoaded', () => {

    let AppState = {
        full_data: {},
        player_order: [],
        session: {},
        pitch_count_summary: {},
    };
    let sortableInstances = {};
    let lineupEditorModal;

    const renderPositionSelect = (name, id, selectedVal = '', title = 'Pos', classes = 'form-select form-select-sm') => {
        const positions = ['P', 'C', '1B', '2B', '3B', 'SS', 'LF', 'CF', 'RF', 'DH', 'EH'];
        let optionsHtml = `<option value="" ${!selectedVal ? 'selected' : ''}>${title}</option>`;
        positions.forEach(pos => {
            optionsHtml += `<option value="${pos}" ${selectedVal === pos ? 'selected' : ''}>${pos}</option>`;
        });
        return `<select name="${name}" id="${id}" class="${classes}" title="${title}">${optionsHtml}</select>`;
    };
    const escapeHTML = str => String(str).replace(/[&<>'"]/g, tag => ({'&': '&amp;','<': '&lt;','>': '&gt;',"'": '&#39;','"': '&quot;'}[tag] || tag));
    const canEdit = (author) => AppState.session.username === author || AppState.session.role === 'Head Coach' || AppState.session.role === 'Super Admin';


    function attachRosterSaveListeners() {
        document.querySelectorAll('.save-player-btn').forEach(button => {
            button.removeEventListener('click', handleRosterSave);
            button.addEventListener('click', handleRosterSave);
        });
    }

    async function handleRosterSave(event) {
        const savePlayerBtn = event.target;
        const playerId = savePlayerBtn.dataset.playerId;
        const accordionBody = savePlayerBtn.closest('.accordion-body');
        const formData = new FormData();
        accordionBody.querySelectorAll('input, select, textarea').forEach(input => formData.append(input.name, input.value));

        const originalText = savePlayerBtn.textContent;
        savePlayerBtn.disabled = true;
        savePlayerBtn.textContent = 'Saving...';

        try {
            const response = await fetch(`/update_player_inline/${playerId}`, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (data.status === 'success') {
                savePlayerBtn.textContent = 'Saved!';
                savePlayerBtn.classList.replace('btn-success', 'btn-secondary');
            } else {
                alert(`Error: ${data.message}`);
                savePlayerBtn.textContent = 'Save Failed';
            }
        } catch (err) {
            alert('An error occurred while saving player changes.');
            savePlayerBtn.textContent = 'Save Failed';
        } finally {
            setTimeout(() => {
                savePlayerBtn.textContent = originalText;
                savePlayerBtn.classList.replace('btn-secondary', 'btn-success');
                savePlayerBtn.disabled = false;
            }, 2000);
        }
    }

    function attachTaskListeners() {
        document.querySelectorAll('.task-checkbox').forEach(checkbox => {
            checkbox.removeEventListener('change', handleTaskCheckboxChange);
            checkbox.addEventListener('change', handleTaskCheckboxChange);
        });
    }

    async function handleTaskCheckboxChange(event) {
        const listItem = event.target.closest('.task-item');
        const taskId = listItem.dataset.taskId;
        const planId = listItem.dataset.planId;
        const newStatus = event.target.checked ? 'complete' : 'pending';

        try {
            const response = await fetch(`/update_task_status/${planId}/${taskId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            });
            const result = await response.json();
            if (result.status === 'success') {
                listItem.classList.toggle('complete', event.target.checked);
            } else {
                alert('Error updating task status: ' + result.message);
                event.target.checked = !event.target.checked;
            }
        } catch (error) {
            alert('An error occurred while updating task status.');
            event.target.checked = !event.target.checked;
        }
    }


    function renderRoster() {
        const container = document.getElementById('rosterAccordion');
        const searchTerm = document.getElementById('rosterSearch').value.toLowerCase();
        if (!container) return;

        let html = '';
        let visiblePlayerCount = 0;
        AppState.player_order.forEach((playerName) => {
            const p = AppState.full_data.roster.find(player => player.name === playerName);
            if (!p) return;
            if (searchTerm && !p.name.toLowerCase().includes(searchTerm) && !(p.number||'').toString().includes(searchTerm)) return;

            visiblePlayerCount++;
            const pNameSafe = escapeHTML(p.name);
            const pNotesSafe = escapeHTML(p.notes || '');
            const pNotesAuthorSafe = escapeHTML(p.notes_author || '');

            html += `
            <div class="accordion-item" data-player-name="${pNameSafe}">
                <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-roster-${p.id}"><i class="bi bi-grip-vertical me-2 drag-handle" title="Drag to reorder"></i><strong>${pNameSafe}</strong>&nbsp;(#${p.number || 'N/A'})</button></h2>
                <div id="collapse-roster-${p.id}" class="accordion-collapse collapse" data-bs-parent="#rosterAccordion"><div class="accordion-body">
                    <div class="row g-3 align-items-center">
                        <div class="col-12"><h5 class="mb-0">Player Profile Notes</h5></div>
                        <div class="col-12"><textarea class="form-control" name="notes" rows="2" placeholder="General Player Notes">${pNotesSafe}</textarea></div>
                        ${(p.notes_author && p.notes_author !== 'N/A') ? `<div class="col-12 text-end"><small class="text-muted fst-italic">Last saved: ${pNotesAuthorSafe} on ${p.notes_timestamp || ''}</small></div>` : ''}
                        <hr class="my-3">
                        <div class="col-12 col-md-4"><input type="text" class="form-control" name="name" value="${pNameSafe}" placeholder="Name"></div>
                        <div class="col-6 col-md-2"><input type="number" class="form-control" name="number" value="${p.number || ''}" placeholder="J#"></div>
                        <div class="col-6 col-md-3">${renderPositionSelect('position1', `position1_${p.id}`, p.position1, 'Pos1', 'form-select')}</div>
                        <div class="col-6 col-md-3">${renderPositionSelect('position2', `position2_${p.id}`, p.position2, 'Pos2', 'form-select')}</div>
                        <div class="col-6 col-md-3">${renderPositionSelect('position3', `position3_${p.id}`, p.position3, 'Pos3', 'form-select')}</div>
                        <div class="col-6 col-md-3"><select name="throws" class="form-select" title="Throws"><option value="Right" ${p.throws === 'Right' ? 'selected' : ''}>Throws: Right</option><option value="Left" ${p.throws === 'Left' ? 'selected' : ''}>Throws: Left</option></select></div>
                        <div class="col-6 col-md-3"><select name="bats" class="form-select" title="Bats"><option value="Right" ${p.bats === 'Right' ? 'selected' : ''}>Bats: Right</option><option value="Left" ${p.bats === 'Left' ? 'selected' : ''}>Bats: Left</option></select></div>
                        <div class="col-6 col-md-3"><select name="pitcher_role" class="form-select" title="Pitcher Role"><option value="Not a Pitcher" ${p.pitcher_role === "Not a Pitcher" ? 'selected' : ''}>Not a Pitcher</option><option value="Starter" ${p.pitcher_role === "Starter" ? 'selected' : ''}>Starter</option><option value="Reliever" ${p.pitcher_role === "Reliever" ? 'selected' : ''}>Reliever</option></select></div>
                        <div class="col-12 d-flex justify-content-end mt-3"><button type="button" class="btn btn-sm btn-success me-2 save-player-btn" data-player-id="${p.id}">Save Changes</button><a href="/delete_player/${p.id}?active_tab=#roster" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?');">Remove</a></div>
                    </div>
                </div></div>
            </div>`;
        });
        if (visiblePlayerCount === 0) html = `<div class="p-3 text-center text-muted">No players found.</div>`;
        container.innerHTML = html;
        attachRosterSaveListeners();
    }

    function renderPlayerDevelopment() {
        const container = document.getElementById('player-dev-accordion');
        if (!container) return;
        let html = '';
        const playerDevData = AppState.full_data.player_development || {};
        const roster = AppState.full_data.roster || [];

        const getIconForType = (type) => {
            switch(type) {
                case 'Development': return '<i class="bi bi-graph-up-arrow text-primary"></i>';
                case 'Coach Note': return '<i class="bi bi-chat-left-text-fill text-info"></i>';
                case 'Lessons': return '<i class="bi bi-person-video3 text-success"></i>';
                default: return '<i class="bi bi-record-circle"></i>';
            }
        };

        const createActionButtons = (log) => {
            if (!canEdit(log.author)) return '';

            let editButton = '', deleteLink = '';

            if (log.type === 'Development') {
                editButton = `<button class="btn btn-sm btn-link text-secondary py-0" data-bs-toggle="modal" data-bs-target="#editFocusModal" data-focus-id="${log.id}" data-player-name="${log.player_name}">Edit</button>`;
                deleteLink = `<a href="/delete_focus/${log.id}" class="btn btn-sm btn-link text-danger py-0" onclick="return confirm('Are you sure?');">Delete</a>`;
            } else if (log.type === 'Coach Note') {
                const noteText = escapeHTML(log.text);
                editButton = `<button class="btn btn-sm btn-link text-secondary py-0" data-bs-toggle="modal" data-bs-target="#editNoteModal" data-note-id="${log.id}" data-note-type="player_notes" data-note-text="${noteText}">Edit</button>`;
                deleteLink = `<a href="/delete_note/player_notes/${log.id}" class="btn btn-sm btn-link text-danger py-0" onclick="return confirm('Are you sure?');">Delete</a>`;
            }
            return `<div class="mt-2">${editButton}${deleteLink}</div>`;
        };

        AppState.player_order.forEach((playerName) => {
            const p = roster.find(player => player.name === playerName);
            if (!p) return;
            const activityLog = playerDevData[p.name] || [];
            const pNameSafe = escapeHTML(p.name);
            
            html += `
            <div class="accordion-item" data-player-name="${pNameSafe}">
                <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-dev-${p.id}"><i class="bi bi-grip-vertical me-2 drag-handle"></i><strong>${pNameSafe}</strong></button></h2>
                <div id="collapse-dev-${p.id}" class="accordion-collapse collapse" data-bs-parent="#player-dev-accordion"><div class="accordion-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Activity Log</h5>
                        <div class="btn-group"><button class="btn btn-sm btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Add New Entry</button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item add-focus-btn" href="#" data-bs-toggle="modal" data-bs-target="#editFocusModal" data-player-name="${pNameSafe}" data-skill="hitting">New Hitting Focus</a></li>
                                <li><a class="dropdown-item add-focus-btn" href="#" data-bs-toggle="modal" data-bs-target="#editFocusModal" data-player-name="${pNameSafe}" data-skill="pitching">New Pitching Focus</a></li>
                                <li><a class="dropdown-item add-focus-btn" href="#" data-bs-toggle="modal" data-bs-target="#editFocusModal" data-player-name="${pNameSafe}" data-skill="fielding">New Fielding Focus</a></li>
                                <li><a class="dropdown-item add-focus-btn" href="#" data-bs-toggle="modal" data-bs-target="#editFocusModal" data-player-name="${pNameSafe}" data-skill="baserunning">New Baserunning Focus</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#collaboration" onclick="document.querySelector('#collab-player-select').value='${pNameSafe}'; new bootstrap.Tab(document.querySelector('a[href=\\'#collaboration\\']')).show();">New Coach Note</a></li>
                            </ul>
                        </div>
                    </div>
                    ${activityLog.length > 0 ? `
                    <ul class="list-group">
                        ${activityLog.map(log => {
                            log.player_name = pNameSafe;
                            return `
                            <li class="list-group-item">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${getIconForType(log.type)} ${escapeHTML(log.type)}: <span class="text-muted fw-normal">${escapeHTML(log.subtype)}</span></h6>
                                    <small>${log.date}</small>
                                </div>
                                <p class="mb-1">${escapeHTML(log.text)}</p>
                                ${log.notes ? `<p class="mb-1 text-muted small fst-italic">Notes: ${escapeHTML(log.notes)}</p>` : ''}
                                <small class="text-muted">By: ${escapeHTML(log.author)}</small>
                                ${createActionButtons(log)}
                            </li>`;
                        }).join('')}
                    </ul>` : `<div class="text-center p-3 border rounded"><p>No activity logged for this player yet.</p></div>`}
                </div></div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function renderLineups() {
        const container = document.getElementById('lineupsAccordion');
        if (!container) return;
        const lineups = AppState.full_data.lineups.filter(l => !l.associated_game_id) || [];
        
        if (lineups.length === 0) {
            container.innerHTML = `<div class="text-center p-4 border rounded"><p class="mb-0">No unassigned lineups saved yet.</p></div>`;
        } else {
            container.innerHTML = lineups.map((l) => `
            <div class="accordion-item" data-lineup-id="${l.id}"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#lineup-collapse-${l.id}"><strong>${escapeHTML(l.title)}</strong></button></h2>
                <div id="lineup-collapse-${l.id}" class="accordion-collapse collapse" data-bs-parent="#lineupsAccordion"><div class="accordion-body">
                    <div class="d-flex justify-content-end mb-3"><button class="btn btn-sm btn-info me-2 edit-lineup-btn" data-bs-toggle="modal" data-bs-target="#lineupEditorModal" data-lineup-id="${l.id}">Edit</button><a href="/delete_lineup/${l.id}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?');">Delete</a></div>
                    <table class="table table-striped table-sm"><thead><tr><th style="width: 5%;">#</th><th>Player</th><th style="width: 15%;">Position</th></tr></thead>
                        <tbody>${(l.lineup_positions || []).map((spot, i) => `<tr><td><strong>${i + 1}</strong></td><td>${escapeHTML(spot.name)}</td><td>${spot.position}</td></tr>`).join('') || `<tr><td colspan="3" class="text-center text-muted">This lineup is empty.</td></tr>`}</tbody>
                    </table>
                </div></div>
            </div>`).join('');
        }
    }

    function renderPitchingLog() {
        const summaryContainer = document.getElementById('pitch-count-summary-container');
        if (summaryContainer) {
            let summaryHtml = `<table class="table table-sm table-bordered"><thead class="table-light"><tr><th>Pitcher</th><th>Daily (Limit: 85)</th><th>Weekly (Limit: 100)</th><th>Cumulative (Yearly)</th></tr></thead><tbody>`;
            const summaryData = AppState.pitch_count_summary || {};
            if (Object.keys(summaryData).length > 0) {
                for (const [name, counts] of Object.entries(summaryData)) {
                    const dailyPct = Math.min((counts.daily / 85 * 100), 100);
                    const weeklyPct = Math.min((counts.weekly / 100 * 100), 100);
                    const dailyBg = dailyPct > 80 ? 'bg-danger' : dailyPct > 60 ? 'bg-warning' : 'bg-success';
                    const weeklyBg = weeklyPct > 80 ? 'bg-danger' : weeklyPct > 60 ? 'bg-warning' : 'bg-success';
                    summaryHtml += `
                    <tr><td><strong>${escapeHTML(name)}</strong></td>
                        <td><div class="progress" style="height: 20px;"><div class="progress-bar ${dailyBg}" role="progressbar" style="width: ${dailyPct}%;" aria-valuenow="${counts.daily}">${counts.daily}</div></div></td>
                        <td><div class="progress" style="height: 20px;"><div class="progress-bar ${weeklyBg}" role="progressbar" style="width: ${weeklyPct}%;" aria-valuenow="${counts.weekly}">${counts.weekly}</div></div></td>
                        <td class="text-center align-middle"><strong>${counts.cumulative_year || 0}</strong></td>
                    </tr>`;
                }
            } else {
                summaryHtml += `<tr><td colspan="4" class="text-center">No pitching outings recorded yet.</td></tr>`;
            }
            summaryHtml += `</tbody></table>`;
            summaryContainer.innerHTML = summaryHtml;
        }

        const pitcherSelect = document.getElementById('pitching-log-pitcher-select');
        if (pitcherSelect) {
            pitcherSelect.innerHTML = `<option value="">Select Pitcher</option>` + AppState.full_data.roster.filter(p=>p.pitcher_role !== 'Not a Pitcher').map(p => `<option value="${escapeHTML(p.name)}">${escapeHTML(p.name)}</option>`).join('');
        }

        const outingsList = document.getElementById('recorded-outings-list');
        if (outingsList) {
            const outings = (AppState.full_data.pitching || []).sort((a,b) => b.date.localeCompare(a.date)).slice(0, 10);
            outingsList.innerHTML = outings.map((o) => `
                <li class="list-group-item d-flex justify-content-between align-items-center"><span>${o.date}: <strong>${escapeHTML(o.pitcher)}</strong> vs ${escapeHTML(o.opponent)} - ${o.pitches} pitches <span class="badge bg-info">${o.outing_type}</span></span>
                <a href="/delete_pitching/${o.id}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?');"><i class="bi bi-trash"></i></a></li>`).join('') || `<li class="list-group-item text-muted">No outings recorded.</li>`;
        }
    }

    function renderSigns() {
        const container = document.getElementById('signs-list-container');
        if (!container) return;
        const signs = AppState.full_data.signs || [];
        container.innerHTML = signs.length > 0 ? signs.map((sign) => `
            <li class="list-group-item d-flex justify-content-between align-items-center"><div><strong>${escapeHTML(sign.name)}:</strong> ${escapeHTML(sign.indicator)}</div>
            <div><button class="btn btn-sm btn-info edit-sign-btn" data-bs-toggle="modal" data-bs-target="#editSignModal" data-sign-id="${sign.id}">Edit</button><a href="/delete_sign/${sign.id}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?')">Delete</a></div></li>`).join('') : `<li class="list-group-item">No signs have been added.</li>`;
    }

    function renderCollaborationNotes() {
        const teamContainer = document.getElementById('team-notes-container');
        const playerContainer = document.getElementById('player-notes-container');
        if (!teamContainer || !playerContainer) return;
        const collabData = AppState.full_data.collaboration_notes || {};

        const createNoteHTML = (note, note_type) => {
            const noteText = escapeHTML(note.text);
            const author = escapeHTML(note.author);
            return `<div class="card mb-2"><div class="card-body pb-2"><p class="card-text" style="white-space: pre-wrap;">${noteText}</p><small class="text-muted">By ${author} on ${note.timestamp}${note.player_name ? ` for <strong>${escapeHTML(note.player_name)}</strong>` : ''}</small></div>
                <div class="card-footer bg-white border-top-0 text-end py-2">
                    ${canEdit(note.author) ? `<button class="btn btn-sm btn-link text-secondary" data-bs-toggle="modal" data-bs-target="#editNoteModal" data-note-id="${note.id}" data-note-type="${note_type}" data-note-text="${noteText}">Edit</button>` : ''}
                    <a href="/move_note_to_practice_plan/${note_type}/${note.id}" class="btn btn-sm btn-link text-secondary">Move to Plan</a>
                    ${canEdit(note.author) ? `<a href="/delete_note/${note_type}/${note.id}" class="btn btn-sm btn-link text-danger" onclick="return confirm('Are you sure?')">Delete</a>` : ''}
                </div></div>`;
        };

        const teamNotes = (collabData.team_notes || []).sort((a,b) => b.timestamp.localeCompare(a.timestamp));
        teamContainer.innerHTML = teamNotes.map(note => createNoteHTML(note, 'team_notes')).join('') || '<div class="text-center p-3 border rounded text-muted">No team notes yet.</div>';
        const playerNotes = (collabData.player_notes || []).sort((a,b) => b.timestamp.localeCompare(a.timestamp));
        playerContainer.innerHTML = playerNotes.map(note => createNoteHTML(note, 'player_notes')).join('') || '<div class="text-center p-3 border rounded text-muted">No player notes yet.</div>';
        document.getElementById('collab-player-select').innerHTML = '<option value="">Select a player...</option>' + AppState.player_order.map(name => `<option value="${escapeHTML(name)}">${escapeHTML(name)}</option>`).join('');
    }

    function renderScoutingList() {
        const container = document.getElementById('scouting-list-container');
        if (!container) return;
        const scoutingData = AppState.full_data.scouting_list || {};
        const listTypes = {'targets': 'Targets', 'committed': 'Committed', 'not_interested': 'Not Interested'};
        let html = '';
        for (const [key, title] of Object.entries(listTypes)) {
            html += `<div class="col-md-4 mb-3"><div class="card h-100"><div class="card-header fw-bold">${title}</div><div class="card-body p-0"><ul class="list-group list-group-flush">`;
            const players = scoutingData[key] || [];
            if (players.length > 0) {
                players.forEach((p) => {
                    let moveOptions = '';
                    if (key === 'targets') moveOptions = `<li><form action="/move_scouted_player/targets/committed/${p.id}" method="POST" class="d-inline"><button type="submit" class="dropdown-item">Move to Committed</button></form></li><li><form action="/move_scouted_player/targets/not_interested/${p.id}" method="POST" class="d-inline"><button type="submit" class="dropdown-item">Move to Not Interested</button></form></li>`;
                    else if (key === 'committed') moveOptions = `<li><form action="/move_scouted_player_to_roster/${p.id}" method="POST" class="d-inline"><button type="submit" class="dropdown-item fw-bold">Move to Roster</button></form></li><li><hr class="dropdown-divider"></li><li><form action="/move_scouted_player/committed/not_interested/${p.id}" method="POST" class="d-inline"><button type="submit" class="dropdown-item">Move to Not Interested</button></form></li>`;

                    html += `<li class="list-group-item d-flex justify-content-between align-items-center"><div><div class="fw-bold">${escapeHTML(p.name)}</div><small class="text-muted">Pos: ${p.position1 || 'N/A'}${p.position2 ? ` / ${p.position2}` : ''} | Throws: ${p.throws || 'N/A'} | Bats: ${p.bats || 'N/A'}</small></div>
                        <div class="btn-group"><a href="/delete_scouted_player/${key}/${p.id}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?');" title="Remove Player"><i class="bi bi-trash"></i></a>
                        ${moveOptions ? `<button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false"><span class="visually-hidden">Toggle Dropdown</span></button><ul class="dropdown-menu dropdown-menu-end">${moveOptions}</ul>` : ''}</div></li>`;
                });
            } else html += `<li class="list-group-item text-center text-muted">No players on this list.</li>`;
            html += `</ul></div></div></div>`;
        }
        container.innerHTML = html;
    }

    function renderGames() {
        const container = document.getElementById('games-list-container');
        if (!container) return;
        const games = (AppState.full_data.games || []).sort((a,b) => b.date.localeCompare(a.date));
        if (games.length === 0) {
            container.innerHTML = `<li class="list-group-item text-center text-muted">No games scheduled. Add one above!</li>`;
            return;
        }
        container.innerHTML = games.map(game => {
            const lineup = AppState.full_data.lineups.find(l => l.associated_game_id === game.id);
            const rotation = AppState.full_data.rotations.find(r => r.associated_game_id === game.id);
            const lineupHTML = lineup ? `<span class="text-success"><i class="bi bi-check-circle-fill"></i> Set</span>` : `<span class="text-muted"><i class="bi bi-x-circle"></i> Not Set</span>`;
            const rotationHTML = rotation ? `<span class="text-success"><i class="bi bi-check-circle-fill"></i> Set</span>` : `<span class="text-muted"><i class="bi bi-x-circle"></i> Not Set</span>`;
            return `<li class="list-group-item" data-game-id="${game.id}">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div class="me-auto">
                        <h5 class="mb-1">vs ${escapeHTML(game.opponent)}</h5>
                        <p class="mb-1"><i class="bi bi-calendar-event"></i> ${game.date} <span class="text-muted mx-2">|</span> <i class="bi bi-geo-alt"></i> ${escapeHTML(game.location || 'TBD')}</p>
                    </div>
                    <div class="d-flex align-items-center mt-2 mt-md-0">
                        <div class="text-end me-3"><div class="mb-1"><strong>Lineup:</strong> ${lineupHTML}</div><div><strong>Rotation:</strong> ${rotationHTML}</div></div>
                        <div class="btn-group-vertical btn-group-sm">
                            <a href="/game/${game.id}" class="btn btn-primary"><i class="bi bi-tools"></i> Manage</a>
                            <a href="/delete_game/${game.id}" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to delete this game?');"><i class="bi bi-trash"></i> Delete</a>
                        </div>
                    </div>
                </div></li>`;
        }).join('');
    }

    function renderPracticePlans() {
        const container = document.getElementById('practicePlanAccordion');
        if (!container) return;
        const plans = (AppState.full_data.practice_plans || []).sort((a,b) => b.date.localeCompare(a.date));
        if (plans.length === 0) {
            container.innerHTML = `<div class="text-center p-4 border rounded"><p class="mb-0">No practice plans saved yet. Create one above!</p></div>`;
            return;
        }
        container.innerHTML = plans.map(plan => `
            <div class="accordion-item" data-plan-id="${plan.id}"><h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#practice-plan-collapse-${plan.id}"><strong>${plan.date}</strong> - ${escapeHTML(plan.general_notes || 'No general notes')}</button></h2>
                <div id="practice-plan-collapse-${plan.id}" class="accordion-collapse collapse" data-bs-parent="#practicePlanAccordion"><div class="accordion-body practice-plan">
                    <form action="/edit_practice_plan/${plan.id}" method="POST" class="row g-3 mb-3 align-items-end">
                        <div class="col-md-3"><label class="form-label">Date:</label><input type="date" name="plan_date" class="form-control" value="${plan.date}" required></div>
                        <div class="col-md-7"><label class="form-label">General Notes:</label><input type="text" name="general_notes" class="form-control" value="${escapeHTML(plan.general_notes || '')}" placeholder="General theme or focus"></div>
                        <div class="col-md-2 d-flex justify-content-end"><button type="submit" class="btn btn-sm btn-primary me-2">Save</button><a href="/delete_practice_plan/${plan.id}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this practice plan and all its tasks?');">Delete</a></div>
                    </form><hr><h5>Tasks</h5>
                    <form action="/add_task_to_plan/${plan.id}" method="POST" class="mb-3 add-task-form"><div class="input-group"><input type="text" name="task_text" class="form-control" placeholder="Add a new task..." required><button type="submit" class="btn btn-primary">Add Task</button></div></form>
                    <ul class="list-group task-list">${(plan.tasks || []).map(task => `<li class="list-group-item d-flex justify-content-between align-items-center task-item ${task.status === 'complete' ? 'complete' : ''}" data-task-id="${task.id}" data-plan-id="${plan.id}">
                        <div class="form-check"><input class="form-check-input task-checkbox" type="checkbox" value="" ${task.status === 'complete' ? 'checked' : ''} id="task-${task.id}"><label class="form-check-label" for="task-${task.id}">${escapeHTML(task.text)}<div class="text-muted small">By ${escapeHTML(task.author)} on ${task.timestamp}</div></label></div>
                        <a href="/delete_task/${plan.id}/${task.id}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?');"><i class="bi bi-trash"></i></a></li>`).join('') || '<li class="list-group-item text-muted text-center">No tasks for this plan yet.</li>'}</ul>
                </div></div>
            </div>`).join('');
        attachTaskListeners();
    }


    function renderAll() {
        renderRoster();
        renderPlayerDevelopment();
        renderLineups();
        renderPitchingLog();
        renderSigns();
        renderCollaborationNotes();
        renderScoutingList();
        renderGames();
        renderPracticePlans();
    }

    async function init() {
        const addGameDateInput = document.getElementById('add_game_date');
        if (addGameDateInput) {
            addGameDateInput.valueAsDate = new Date();
        }

        try {
            const response = await fetch('/get_app_data');
            if (!response.ok) throw new Error(`Failed to fetch app data: ${response.statusText}`);
            AppState = await response.json();
        } catch (error) {
            console.error("Initialization Error: Failed to fetch app data.", error);
            document.body.innerHTML = `<div class="alert alert-danger m-3">Could not load application data. Please try refreshing.</div>`;
            return;
        }

        renderAll();
        lineupEditorModal = new bootstrap.Modal(document.getElementById('lineupEditorModal'));
        initializeSortables();
        setupEventListeners();

        setTimeout(() => {
            const hash = window.location.hash || '#roster';
            const tabId = hash.split('?')[0];
            let targetTabLink = document.querySelector(`a[data-bs-toggle="tab"][href="${tabId}"]`);
            if (targetTabLink && !targetTabLink.closest('.more-menu-overlay')) {
                new bootstrap.Tab(targetTabLink).show();
            } else {
                 new bootstrap.Tab(document.querySelector('a[data-bs-toggle="tab"]')).show();
            }
        }, 100);

        const socket = io();
        socket.on('data_updated', async (msg) => {
            console.log('Data update received:', msg.message);
            
            const openPlanItem = document.querySelector('#practicePlanAccordion .accordion-collapse.show');
            const openPlanId = openPlanItem ? openPlanItem.closest('.accordion-item').dataset.planId : null;

            try {
                const response = await fetch('/get_app_data');
                AppState = await response.json();
                
                renderAll(); 

                if (openPlanId) {
                    const newCollapseElement = document.getElementById(`practice-plan-collapse-${openPlanId}`);
                    const newButtonElement = document.querySelector(`button[data-bs-target="#practice-plan-collapse-${openPlanId}"]`);
                    
                    if (newCollapseElement && newButtonElement) {
                        newCollapseElement.classList.add('show');
                        newButtonElement.classList.remove('collapsed');
                        newButtonElement.setAttribute('aria-expanded', 'true');
                    }
                }
            } catch (error) {
                console.error("Error refreshing data:", error);
            }
        });
    }

    function initializeSortables() {
        Object.values(sortableInstances).forEach(s => { if (s.destroy) s.destroy(); });
        sortableInstances = {};
        const createSortable = (id, handleClass) => {
            const el = document.getElementById(id);
            if(el) {
                sortableInstances[id] = new Sortable(el, {
                    handle: handleClass,
                    animation: 150,
                    scroll: true, 
                    scrollSensitivity: 50,
                    onEnd: () => {
                        const newPlayerOrder = Array.from(el.children).map(item => item.dataset.playerName);
                        AppState.player_order = newPlayerOrder;
                        fetch('/save_player_order', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ player_order: newPlayerOrder })
                        });
                    }
                });
            }
        };
        createSortable('rosterAccordion', '.drag-handle');
        createSortable('player-dev-accordion', '.drag-handle');
    }


    function setupEventListeners() {
        document.getElementById('rosterSearch').addEventListener('input', renderRoster);
        
        document.body.addEventListener('submit', async (event) => {
            if (event.target.classList.contains('add-task-form')) {
                event.preventDefault(); 

                const form = event.target;
                const input = form.querySelector('input[name="task_text"]');
                const button = form.querySelector('button[type="submit"]');
                const taskText = input.value.trim();
                const url = form.action;

                if (!taskText) {
                    alert('Please enter a task.');
                    return;
                }

                input.disabled = true;
                button.disabled = true;
                button.textContent = 'Adding...';

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ task_text: taskText })
                    });

                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.message || 'An unknown error occurred.');
                    }
                    
                    input.value = '';
                } catch (error) {
                    console.error('Failed to add task:', error);
                    alert(`Error: ${error.message}`);
                } finally {
                    input.disabled = false;
                    button.disabled = false;
                    button.textContent = 'Add Task';
                }
            }
        });

        document.getElementById('addScoutedPlayerForm')?.addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target, feedbackEl = document.getElementById('addScoutedPlayerFeedback');
            const data = Object.fromEntries(new FormData(form).entries());
            try {
                const response = await fetch('/add_scouted_player', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                feedbackEl.innerHTML = `<div class="alert alert-success p-2">${escapeHTML(result.message)}</div>`;
                form.reset();
            } catch (error) {
                feedbackEl.innerHTML = `<div class="alert alert-danger p-2">${escapeHTML(error.message)}</div>`;
            }
        });
        
        document.body.addEventListener('show.bs.tab', function (event) {
            const tabPanes = document.querySelectorAll('.tab-content .tab-pane');
            const targetPaneId = event.target.getAttribute('href');
            tabPanes.forEach(pane => {
                if (`#${pane.id}` !== targetPaneId) {
                    pane.classList.remove('show', 'active');
                }
            });
        });

        const moreMenuButton = document.getElementById('mobile-more-button');
        const moreMenuOverlay = document.getElementById('more');
        const moreMenuCloseButton = document.getElementById('more-menu-close-btn');

        if (moreMenuButton && moreMenuOverlay) {
            const hideMoreMenu = () => moreMenuOverlay.classList.add('hidden');
            const showMoreMenu = () => {
                moreMenuOverlay.classList.remove('hidden');
                document.querySelectorAll('#mobile-nav-tabs .nav-link').forEach(link => link.classList.remove('active'));
                moreMenuButton.classList.add('active');
            };

            moreMenuButton.addEventListener('click', (event) => {
                event.preventDefault();
                showMoreMenu();
            });
            
            moreMenuCloseButton.addEventListener('click', hideMoreMenu);

            moreMenuOverlay.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (event) => {
                    if (!link.hasAttribute('data-bs-toggle')) {
                         hideMoreMenu();
                    } else {
                        setTimeout(hideMoreMenu, 150);
                    }
                });
            });
        }
        
        document.body.addEventListener('shown.bs.tab', (event) => {
            const newTabId = event.target.getAttribute('href');
            if (history.pushState) history.pushState(null, null, newTabId); else location.hash = newTabId;

            if (!moreMenuOverlay.classList.contains('hidden') && !event.target.closest('.more-menu-overlay')) {
                moreMenuOverlay.classList.add('hidden');
            }

            document.querySelectorAll('#mobile-nav-tabs .nav-link').forEach(link => {
                link.classList.remove('active');
            });

            const mobileNavLink = document.querySelector(`#mobile-nav-tabs a[href="${newTabId}"]`);
            if (mobileNavLink) {
                mobileNavLink.classList.add('active');
            } else {
                if (moreMenuOverlay.querySelector(`a[href="${newTabId}"]`)) {
                    document.getElementById('mobile-more-button')?.classList.add('active');
                }
            }
        });

        document.body.addEventListener('click', function(event){
            if(event.target.closest('.edit-sign-btn')) {
                const signId = parseInt(event.target.closest('.edit-sign-btn').dataset.signId, 10);
                const sign = AppState.full_data.signs.find(s => s.id === signId);
                const form = document.getElementById('editSignForm');
                form.action = `/update_sign/${sign.id}`;
                form.querySelector('#editSignName').value = sign.name;
                form.querySelector('#editSignIndicator').value = sign.indicator;
            }
        });
        
        document.getElementById('lineupEditorModal')?.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            const lineupId = button ? button.dataset.lineupId : null;
            const lineup = lineupId ? AppState.full_data.lineups.find(l => l.id == lineupId) : null;
            openLineupEditor(lineup);
        });
        
        document.getElementById('editNoteModal')?.addEventListener('show.bs.modal', (e) => {
            e.target.querySelector('#editNoteId').value = e.relatedTarget.dataset.noteId;
            e.target.querySelector('#editNoteType').value = e.relatedTarget.dataset.noteType;
            e.target.querySelector('#editNoteText').value = e.relatedTarget.dataset.noteText;
        });

        document.getElementById('editFocusModal')?.addEventListener('show.bs.modal', (e) => {
            const btn = e.relatedTarget;
            const form = e.target.querySelector('form');
            form.reset();

            const focusId = btn.dataset.focusId;
            if (focusId) {
                e.target.querySelector('.modal-title').textContent = 'Edit Development Focus';
                form.action = `/update_focus/${focusId}`;

                let focusItem = null;
                const playerName = btn.dataset.playerName;
                if (AppState.full_data.player_development[playerName]) {
                    focusItem = AppState.full_data.player_development[playerName].find(item => item.id == focusId && item.type === 'Development');
                }

                if (focusItem) {
                    form.querySelector('#focusSkill').value = focusItem.subtype;
                    form.querySelector('#focusText').value = focusItem.text.replace(/^(New Focus|Completed): /i, '');
                    form.querySelector('#focusNotes').value = focusItem.notes || '';
                }
            } else {
                e.target.querySelector('.modal-title').textContent = 'Add Development Focus';
                form.action = `/add_focus/${encodeURIComponent(btn.dataset.playerName)}`;
                form.querySelector('#focusSkill').value = btn.dataset.skill;
            }
        });
        
        document.getElementById('saveLineupBtn')?.addEventListener('click', async () => {
            const modal = document.getElementById('lineupEditorModal');
            const id = modal.querySelector('#lineupId').value;
            const title = modal.querySelector('#lineupTitle').value;
            if (!title) return alert('Lineup Title is required.');
            const lineup_data = Array.from(modal.querySelectorAll('#lineup-order .list-group-item')).map(item => ({
                name: item.dataset.playerName, position: item.querySelector('select')?.value || '' }));
            const payload = { title, lineup_data, associated_game_id: null };
            const url = id ? `/edit_lineup/${id}` : '/add_lineup';
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if(!response.ok) throw new Error((await response.json()).message);
                lineupEditorModal.hide();
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        });
    }

    function openLineupEditor(lineup = null) {
        const modal = document.getElementById('lineupEditorModal');
        modal.querySelector('#lineupId').value = lineup ? lineup.id : '';
        modal.querySelector('#lineupTitle').value = lineup ? lineup.title : 'New Unassigned Lineup';
        const bench = modal.querySelector('#lineup-bench'), order = modal.querySelector('#lineup-order');
        bench.innerHTML = '', order.innerHTML = '';

        const lineupPlayerNames = new Set((lineup ? lineup.lineup_positions : []).map(p => p.name));
        AppState.full_data.roster.forEach(player => {
            if (!lineupPlayerNames.has(player.name)) {
                const playerEl = document.createElement('div');
                playerEl.className = 'list-group-item';
                playerEl.textContent = player.name;
                playerEl.dataset.playerName = player.name;
                bench.appendChild(playerEl);
            }
        });
        const createBattingOrderItem = (player, selectedPosition = null) => {
            const item = document.createElement('div');
            item.className = 'list-group-item d-flex justify-content-between align-items-center';
            item.dataset.playerName = player.name;
            const nameSpan = document.createElement('span');
            nameSpan.textContent = `${player.name} (#${player.number || 'N/A'})`;
            item.appendChild(nameSpan);
            item.insertAdjacentHTML('beforeend', renderPositionSelect('pos', '', selectedPosition || player.position1));
            return item;
        };
        (lineup ? lineup.lineup_positions : []).forEach(spot => {
            const player = AppState.full_data.roster.find(p => p.name === spot.name);
            if (player) order.appendChild(createBattingOrderItem(player, spot.position));
        });
        if(sortableInstances.unassignedLineupBench) sortableInstances.unassignedLineupBench.destroy();
        if(sortableInstances.unassignedLineupOrder) sortableInstances.unassignedLineupOrder.destroy();
        sortableInstances.unassignedLineupBench = new Sortable(bench, { group: 'lineup', animation: 150 });
        sortableInstances.unassignedLineupOrder = new Sortable(order, { group: 'lineup', animation: 150,
            onAdd: (evt) => {
                const player = AppState.full_data.roster.find(p => p.name === evt.item.dataset.playerName);
                if (player) evt.item.replaceWith(createBattingOrderItem(player));
            }
        });
    };

    init();
});
</script>

</body>
</html>