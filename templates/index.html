{% extends "base.html" %}

{% block title %}{{ current_team.team_name }} - Dashboard{% endblock %}

{% macro position_select(name, id, selected_val, title="Select Position", classes="form-select") -%}
    <select name="{{ name }}" id="{{ id }}" class="{{ classes }}" title="{{ title }}">
        <option value="" {% if not selected_val %}selected{% endif %}>{{ title }}</option>
        {%- set positions = ['P', 'C', '1B', '2B', '3B', 'SS', 'LF', 'CF', 'RF', 'DH', 'EH'] -%}
        {%- for pos in positions -%}
            <option value="{{ pos }}" {% if selected_val == pos %}selected{% endif %}>{{ pos }}</option>
        {%- endfor -%}
    </select>
{%- endmacro %}

{% block head %}
<style>
    /* Additional styles specific to this page for better layout */
    .practice-plan { border-left: 3px solid #c8102e; }
    .task-item.complete { text-decoration: line-through; opacity: 0.6; }
    #player-dev-accordion .list-group-item {
        border-left-width: 3px;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}


{% block content %}
<div class="d-none d-lg-block mb-3">
    <ul class="nav nav-tabs desktop-nav-tabs" id="mainTabsDesktop" role="tablist">
        {% for tab_key in tab_order %}
        <li class="nav-item" role="presentation">
            <a class="nav-link" data-bs-toggle="tab" href="#{{ tab_key }}" role="tab">
                <i class="bi bi-grip-vertical me-1 drag-handle" title="Drag to reorder"></i>
                {{ all_tabs[tab_key] }}
            </a>
        </li>
        {% endfor %}
        <li class="nav-item" role="presentation">
            <a class="nav-link" data-bs-toggle="tab" href="#stats_tab" role="tab">
                <i class="bi bi-bar-chart-fill me-1"></i> Stats
            </a>
        </li>
    </ul>
</div>

<div class="tab-content" id="mainTabContent">
    <div class="tab-pane fade" id="roster" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <h4 class="mb-0">Current Roster</h4>
            <div class="d-flex align-items-center gap-2">
                <input type="search" id="rosterSearch" class="form-control" placeholder="Search...">
                <button class="btn btn-primary text-nowrap" data-bs-toggle="modal" data-bs-target="#addPlayerModal">
                    <i class="bi bi-plus-circle"></i> New Player
                </button>
            </div>
        </div>
        <div class="accordion" id="rosterAccordion"></div>
    </div>

    <div class="tab-pane fade" id="player_development" role="tabpanel">
        <div class="player-dev-container">
            <div class="player-list-column">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Players</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" id="dev-sort-az" title="Sort A-Z"><i class="bi bi-sort-alpha-down"></i></button>
                        <button class="btn btn-outline-secondary" id="dev-sort-za" title="Sort Z-A"><i class="bi bi-sort-alpha-up"></i></button>
                         <button class="btn btn-outline-secondary" id="dev-sort-custom" title="Custom Sort"><i class="bi bi-arrow-down-up"></i></button>
                    </div>
                </div>
                 <div class="mb-3">
                    <input type="search" id="devPlayerSearch" class="form-control" placeholder="Search players...">
                </div>
                <div class="list-group" id="dev-player-list">
                </div>
            </div>
            <div class="player-dev-details-column">
                <div id="player-dev-content">
                    <div class="text-center p-5 text-muted">
                        <i class="bi bi-arrow-left-circle-fill" style="font-size: 3rem;"></i>
                        <h4 class="mt-3">Select a player</h4>
                        <p>Select a player from the list to view their development log.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="stats_tab" role="tabpanel">
        {% include '_stats_content.html' %}
    </div>

    <div class="tab-pane fade" id="lineups" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Unassigned Lineups</h4>
        <button class="btn btn-primary" id="createLineupBtn" data-bs-toggle="modal" data-bs-target="#lineupEditorModal">Create New</button>
      </div>
      <div class="accordion" id="lineupsAccordion"></div>
    </div>
    
    <div class="tab-pane fade" id="rotations" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Unassigned Rotations</h4>
        </div>
      <div class="accordion" id="rotationsAccordion"></div>
    </div>

    <div class="tab-pane fade" id="pitching" role="tabpanel">
        <h4>Pitching Log & Count Tracker</h4>
        <div class="card mb-4">
          <div class="card-header"><strong>Pitch Count Summary</strong></div>
          <div class="card-body p-2"><div class="table-responsive" id="pitch-count-summary-container"></div></div>
        </div>
        <div class="row">
          <div class="col-lg-5 mb-4">
            <div class="card h-100">
              <div class="card-header"><strong>Add New Outing</strong></div>
              <div class="card-body">
                <form action="{{ url_for('pitching.add_pitching') }}" method="POST">
                  <div class="row g-3">
                    <div class="col-6"><label for="pitch_date" class="form-label">Date</label><input type="date" id="pitch_date" name="pitch_date" class="form-control" required></div>
                    <div class="col-6"><label for="pitching-log-pitcher-select" class="form-label">Pitcher</label><select name="pitcher" class="form-select" required id="pitching-log-pitcher-select"></select></div>
                    <div class="col-12"><label for="opponent" class="form-label">Opponent / Context</label><input type="text" id="opponent" name="opponent" class="form-control" placeholder="e.g., Scrimmage vs. Tigers"></div>
                    <div class="col-6"><label for="pitches" class="form-label">Pitch Count</label><input type="number" id="pitches" name="pitches" class="form-control" required></div>
                    <div class="col-6"><label for="innings" class="form-label">Innings Pitched</label><input type="text" id="innings" name="innings" class="form-control" placeholder="e.g., 2.1" required></div>
                    <div class="col-6"><label for="outing_type" class="form-label">Outing Type</label><select name="outing_type" id="outing_type" class="form-select"><option value="Game">Game</option><option value="External/Lesson">External/Lesson</option><option value="Practice">Practice</option></select></div>
                    <div class="col-6"><label for="pitcher_type" class="form-label">Pitcher Type</label><select name="pitcher_type" id="pitcher_type" class="form-select"><option value="Starter">Starter</option><option value="Reliever">Reliever</option></select></div>
                  </div>
                  <button type="submit" class="btn btn-primary w-100 mt-3">Log Outing</button>
                </form>
              </div>
            </div>
          </div>
          <div class="col-lg-7 mb-4">
             <div class="card h-100">
                <div class="card-header"><strong>Recent Outing History</strong></div>
                <div class="card-body p-0"><ul class="list-group list-group-flush" id="recorded-outings-list"></ul></div>
             </div>
          </div>
        </div>
    </div>

    <div class="tab-pane fade" id="scouting_list" role="tabpanel">
        <h4 class="mb-3">Scouting & Recruiting Lists</h4>
        <div class="row" id="scouting-list-container"></div>
        <div class="card mt-3">
            <div class="card-body">
                <h5 class="card-title">Add New Scouted Player</h5>
                <form id="addScoutedPlayerForm" class="row g-3">
                    <div class="col-md-3"><input type="text" class="form-control" name="scouted_player_name" placeholder="Player Name" required></div>
                    <div class="col-md-2">{{ position_select('scouted_player_pos1', 'scouted_player_pos1', '', title='Pos 1') }}</div>
                    <div class="col-md-2">{{ position_select('scouted_player_pos2', 'scouted_player_pos2', '', title='Pos 2') }}</div>
                    <div class="col-md-2"><select name="scouted_player_throws" class="form-select"><option value="">Throws</option><option value="Right">Right</option><option value="Left">Left</option></select></div>
                    <div class="col-md-2"><select name="scouted_player_bats" class="form-select"><option value="">Bats</option><option value="Right">Right</option><option value="Left">Left</option></select></div>
                    <div class="col-md-4"><label class="form-label">Add to List:</label><select name="scouted_player_type" class="form-select"><option value="targets">Targets</option><option value="committed">Committed</option><option value="not_interested">Not Interested</option></select></div>
                    <div class="col-md-2 d-flex align-items-end"><button type="submit" class="btn btn-primary w-100">Add</button></div>
                </form>
                <div id="addScoutedPlayerFeedback" class="mt-2"></div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="games" role="tabpanel">
        <h4>Game Schedule & Management</h4>
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Add New Game</h5>
                <form action="{{ url_for('gameday.add_game') }}" method="POST" class="row g-3">
                    <div class="col-md-3"><input type="date" name="game_date" id="add_game_date" class="form-control" required></div>
                    <div class="col-md-3"><input type="text" name="game_opponent" class="form-control" placeholder="Opponent" required></div>
                    <div class="col-md-3"><input type="text" name="game_location" class="form-control" placeholder="Location"></div>
                    <div class="col-md-3"><button type="submit" class="btn btn-primary w-100">Add & Manage</button></div>
                    <div class="col-12"><textarea name="game_notes" class="form-control" rows="2" placeholder="Notes (e.g., arrival time)"></textarea></div>
                </form>
            </div>
        </div>
        <ul class="list-group" id="games-list-container"></ul>
    </div>

    <div class="tab-pane fade" id="collaboration" role="tabpanel">
        <h4>Coaches Log</h4>
        <div class="row">
            <div class="col-md-6">
                <h5>Team Notes</h5>
                <div class="card mb-3"><div class="card-body">
                    <form action="{{ url_for('team_management.add_note', note_type='team_notes') }}" method="POST">
                        <textarea name="note_text" class="form-control mb-2" rows="3" placeholder="Add a new note..."></textarea>
                        <button type="submit" class="btn btn-primary btn-sm">Add Team Note</button>
                    </form>
                </div></div>
                <div id="team-notes-container"></div>
            </div>
            <div class="col-md-6">
                <h5>Player Notes</h5>
                <div class="card mb-3"><div class="card-body">
                    <form action="{{ url_for('team_management.add_note', note_type='player_notes') }}" method="POST">
                        <select name="player_name" class="form-select mb-2" required id="collab-player-select"></select>
                        <textarea name="note_text" class="form-control mb-2" rows="3" placeholder="Add a new note..."></textarea>
                        <button type="submit" class="btn btn-primary btn-sm">Add Player Note</button>
                    </form>
                </div></div>
                <div id="player-notes-container"></div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="practice_plan" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Practice Plans</h4>
            <button class="btn btn-primary d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#createPracticePlanForm" aria-expanded="false">
                <i class="bi bi-plus-circle"></i> Create New
            </button>
        </div>
        <div class="collapse d-lg-block" id="createPracticePlanForm">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Create New Practice Plan</h5>
                    <form action="{{ url_for('team_management.add_practice_plan') }}" method="POST">
                        <div class="row g-3">
                            <div class="col-md-4"><label class="form-label">Date</label><input type="date" name="plan_date" class="form-control" required></div>
                            <div class="col-md-8"><label class="form-label">General Notes</label><input type="text" name="general_notes" class="form-control" placeholder="e.g., Pre-tournament tune-up"></div>
                            <div class="col-12"><label class="form-label">Emphasis</label><textarea name="emphasis" class="form-control" rows="2" placeholder="e.g., First-pitch strikes, aggressive baserunning"></textarea></div>
                            <div class="col-md-6"><label class="form-label">Warm-up / Throwing</label><textarea name="warm_up" class="form-control" rows="3" placeholder="Dynamic warm-up, band work, long toss progression..."></textarea></div>
                            <div class="col-md-6"><label class="form-label">Infield / Outfield</label><textarea name="infield_outfield" class="form-control" rows="3" placeholder="Ground balls, fly balls, double plays..."></textarea></div>
                            <div class="col-md-6"><label class="form-label">Hitting</label><textarea name="hitting" class="form-control" rows="3" placeholder="Tee work, soft toss, live BP..."></textarea></div>
                            <div class="col-md-6"><label class="form-label">Pitching / Catching</label><textarea name="pitching_catching" class="form-control" rows="3" placeholder="Bullpens, blocking drills, framing..."></textarea></div>
                            <div class="col-12 d-flex justify-content-end"><button type="submit" class="btn btn-primary">Create Plan</button></div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div class="accordion" id="practicePlanAccordion"></div>
    </div>


    <div class="tab-pane fade" id="signs" role="tabpanel">
      <h4>Signs & Signals</h4>
        <div class="row">
            <div class="col-md-6"><div class="card"><div class="card-body">
                <h5 class="card-title">Add New Sign</h5>
                <form action="{{ url_for('team_management.add_sign') }}" method="POST">
                    <div class="mb-2"><input type="text" name="sign_name" class="form-control" placeholder="Sign Name" required></div>
                    <div class="mb-2"><input type="text" name="sign_indicator" class="form-control" placeholder="Indicator" required></div>
                    <button type="submit" class="btn btn-primary">Add Sign</button>
                </form>
            </div></div></div>
            <div class="col-md-6"><ul class="list-group" id="signs-list-container"></ul></div>
        </div>
    </div>
</div>

<div class="modal fade" id="addPlayerModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Add New Player</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <form id="addPlayerForm" action="{{ url_for('roster.add_player') }}" method="POST">
        <div class="modal-body">
            <div class="row g-3">
                <div class="col-md-6"><label class="form-label">Player Name</label><input type="text" class="form-control" name="name" required></div>
                <div class="col-md-6"><label class="form-label">Jersey #</label><input type="number" class="form-control" name="number"></div>
                <div class="col-md-4"><label class="form-label">Pos 1</label>{{ position_select('position1', 'add_position1', '', title='') }}</div>
                <div class="col-md-4"><label class="form-label">Pos 2</label>{{ position_select('position2', 'add_position2', '', title='') }}</div>
                <div class="col-md-4"><label class="form-label">Pos 3</label>{{ position_select('position3', 'add_position3', '', title='') }}</div>
                <div class="col-md-4"><label class="form-label">Throws</label><select name="throws" class="form-select"><option value="Right">Right</option><option value="Left">Left</option></select></div>
                <div class="col-md-4"><label class="form-label">Bats</label><select name="bats" class="form-select"><option value="Right">Right</option><option value="Left">Left</option></select></div>
                <div class="col-md-4"><label class="form-label">Pitcher Role</label><select name="pitcher_role" class="form-select"><option value="Not a Pitcher">Not a Pitcher</option><option value="Starter">Starter</option><option value="Reliever">Reliever</option></select></div>
                <div class="col-12"><label class="form-label">Notes</label><textarea class="form-control" name="notes" rows="2"></textarea></div>
            </div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="submit" class="btn btn-primary">Add Player</button></div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Confirm Deletion</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">Are you sure you want to delete <strong id="playerNameToDelete"></strong>?</div>
    <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><a href="#" id="confirmDeleteButton" class="btn btn-danger">Delete</a></div>
  </div></div>
</div>
<div class="modal fade" id="lineupEditorModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Unassigned Lineup Editor</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
            <form onsubmit="return false;">
                <input type="hidden" id="lineupId"><input type="text" class="form-control mb-3" id="lineupTitle" required>
                <div class="row">
                    <div class="col-md-6"><h6>Bench</h6><div id="lineup-bench" class="list-group border rounded p-2" style="min-height: 400px;"></div></div>
                    <div class="col-md-6"><h6>Batting Order</h6><div id="lineup-order" class="list-group border rounded p-2" style="min-height: 400px;"></div></div>
                </div>
            </form>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" id="saveLineupBtn" class="btn btn-primary">Save</button></div>
    </div></div>
</div>
<div class="modal fade" id="editNoteModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <form action="{{ url_for('team_management.edit_note') }}" method="POST">
      <div class="modal-body"><input type="hidden" name="note_id" id="editNoteId"><input type="hidden" name="note_type" id="editNoteType"><textarea class="form-control" name="note_text" id="editNoteText" rows="5" required></textarea></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div></div>
</div>
<div class="modal fade" id="editFocusModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <form method="POST">
      <div class="modal-header"><h5 class="modal-title">Development Focus</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-3"><label class="form-label">Skill</label><select name="skill" id="focusSkill" class="form-select" required><option value="hitting">Hitting</option><option value="pitching">Pitching</option><option value="fielding">Fielding</option><option value="baserunning">Baserunning</option></select></div>
        <div class="mb-3"><label class="form-label">Focus / Goal</label><input type="text" class="form-control" name="focus_text" id="focusText" required></div>
        <div class="mb-3"><label class="form-label">Notes</label><textarea class="form-control" name="notes" id="focusNotes" rows="3"></textarea></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div></div>
</div>
<div class="modal fade" id="editSignModal" tabindex="-1">
    <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Edit Sign</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <form id="editSignForm" method="POST">
            <div class="modal-body">
                <div class="mb-2"><label class="form-label">Sign Name</label><input type="text" name="sign_name" id="editSignName" class="form-control" required></div>
                <div class="mb-2"><label class="form-label">Indicator</label><input type="text" name="sign_indicator" id="editSignIndicator" class="form-control" required></div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
        </form>
    </div></div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}
